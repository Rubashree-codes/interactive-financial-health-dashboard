{% extends "base.html" %}

{% block title %}Dashboard - Financial Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="display-6 fw-bold mb-0">
                        <i class="fas fa-tachometer-alt me-2 text-primary"></i>Dashboard
                    </h1>
                    <p class="text-muted mb-0">Welcome back, {{ current_user.username }}!</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{{ url_for('upload') }}" class="btn btn-primary">
                        <i class="fas fa-upload me-1"></i>Upload Data
                    </a>
                    <a href="{{ url_for('goals') }}" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-1"></i>New Goal
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Financial Overview Cards -->
    <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card income-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Total Income</h6>
                            <h3 class="text-success mb-0 stat-number">${{ "%.2f"|format(total_income) }}</h3>
                            <small class="text-muted">All time</small>
                        </div>
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card expense-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Total Expenses</h6>
                            <h3 class="text-danger mb-0 stat-number">${{ "%.2f"|format(total_expenses) }}</h3>
                            <small class="text-muted">All time</small>
                        </div>
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card balance-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Net Worth</h6>
                            <h3 class="{% if net_worth >= 0 %}text-success{% else %}text-danger{% endif %} mb-0 stat-number">
                                ${{ "%.2f"|format(net_worth) }}
                            </h3>
                            <small class="text-muted">Current balance</small>
                        </div>
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-wallet"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card savings-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title text-muted mb-2">Savings Rate</h6>
                            <h3 class="text-primary mb-0 stat-number">
                                {% if total_income > 0 %}
                                    {{ "%.1f"|format(((total_income - total_expenses) / total_income) * 100) }}%
                                {% else %}
                                    0.0%
                                {% endif %}
                            </h3>
                            <small class="text-muted">Income saved</small>
                        </div>
                        <div class="stat-icon-wrapper">
                            <i class="fas fa-piggy-bank"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card chart-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-line me-2"></i>Monthly Income vs Expenses
                    </h5>
                    <div class="chart-controls">
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshChart('monthlyChart')">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card chart-card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Spending by Category
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Goals and Insights Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card goals-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bullseye me-2"></i>Financial Goals
                    </h5>
                    <a href="{{ url_for('goals') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus"></i> Add Goal
                    </a>
                </div>
                <div class="card-body">
                    {% if goals %}
                        {% for goal in goals[:3] %}
                            <div class="goal-item mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-medium">{{ goal.goal_name }}</span>
                                    <span class="badge bg-primary">{{ "%.1f"|format(goal.progress_percentage) }}%</span>
                                </div>
                                <div class="progress progress-custom">
                                    <div class="progress-bar" role="progressbar" style="width: {{ goal.progress_percentage }}%"></div>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-muted">
                                        ${{ "%.2f"|format(goal.saved_amount) }} saved
                                    </small>
                                    <small class="text-muted">
                                        Goal: ${{ "%.2f"|format(goal.target_amount) }}
                                    </small>
                                </div>
                            </div>
                        {% endfor %}
                        {% if goals|length > 3 %}
                            <div class="text-center mt-3">
                                <a href="{{ url_for('goals') }}" class="btn btn-sm btn-outline-secondary">
                                    View All {{ goals|length }} Goals
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-bullseye fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No goals set yet</h6>
                            <p class="text-muted">Create your first financial goal to start tracking your progress!</p>
                            <a href="{{ url_for('goals') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>Create Goal
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-6">
            <div class="card insights-card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Financial Insights
                    </h5>
                </div>
                <div class="card-body">
                    {% if insights %}
                        <div class="insights-list">
                            {% for insight in insights[:5] %}
                                <div class="insight-item mb-3">
                                    <div class="alert alert-info alert-sm py-2 px-3 mb-0">
                                        <small>{{ insight }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-lightbulb fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No insights yet</h6>
                            <p class="text-muted">Upload transactions to get personalized insights!</p>
                            <a href="{{ url_for('upload') }}" class="btn btn-primary">
                                <i class="fas fa-upload me-1"></i>Upload Data
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions and Badges -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card transactions-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Transactions
                    </h5>
                    <a href="{{ url_for('upload') }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-upload"></i> Upload More
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_transactions %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Description</th>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in recent_transactions %}
                                        <tr>
                                            <td>{{ transaction.date.strftime('%m/%d/%Y') }}</td>
                                            <td>
                                                <span class="transaction-description">
                                                    {{ transaction.description[:40] }}{% if transaction.description|length > 40 %}...{% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ transaction.category }}</span>
                                            </td>
                                            <td>
                                                <span class="amount {% if transaction.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    {% if transaction.amount > 0 %}+{% endif %}${{ "%.2f"|format(transaction.amount) }}
                                                </span>
                                            </td>
                                            <td>
                                                <form method="POST" action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this transaction?')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No transactions yet</h6>
                            <p class="text-muted">Upload your first CSV file to get started!</p>
                            <a href="{{ url_for('upload') }}" class="btn btn-primary">
                                <i class="fas fa-upload me-1"></i>Upload Transactions
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card badges-card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy me-2"></i>Recent Badges
                    </h5>
                    <a href="{{ url_for('badges') }}" class="btn btn-sm btn-outline-primary">
                        View All
                    </a>
                </div>
                <div class="card-body">
                    {% if user_badges %}
                        <div class="badges-list">
                            {% for user_badge in user_badges[:5] %}
                                <div class="badge-item d-flex align-items-center mb-3">
                                    <div class="badge-icon-container me-3">
                                        <span class="badge-icon">{{ user_badge.badge.icon }}</span>
                                    </div>
                                    <div class="badge-content">
                                        <h6 class="mb-0">{{ user_badge.badge.name }}</h6>
                                        <small class="text-muted">{{ user_badge.badge.description }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state text-center py-4">
                            <i class="fas fa-trophy fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">No badges yet</h6>
                            <p class="text-muted">Start tracking to earn your first badge!</p>
                            <a href="{{ url_for('badges') }}" class="btn btn-primary">
                                <i class="fas fa-trophy me-1"></i>View Badges
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Chart data
    const monthlyData = {{ monthly_data|tojson }};
    const categoryData = {{ category_spending|tojson }};
    
    // Monthly Income vs Expenses Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    const monthlyLabels = Object.keys(monthlyData).sort();
    const incomeData = monthlyLabels.map(month => monthlyData[month].income);
    const expenseData = monthlyLabels.map(month => monthlyData[month].expenses);
    
    new Chart(monthlyCtx, {
        type: 'line',
        data: {
            labels: monthlyLabels,
            datasets: [{
                label: 'Income',
                data: incomeData,
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Expenses',
                data: expenseData,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
    
    // Category Spending Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    const categoryLabels = Object.keys(categoryData);
    const categoryAmounts = Object.values(categoryData);
    
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryAmounts,
                backgroundColor: [
                    '#8b5cf6', '#06b6d4', '#84cc16', '#f59e0b',
                    '#ef4444', '#ec4899', '#6366f1', '#10b981',
                    '#f97316', '#14b8a6', '#a855f7', '#3b82f6'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                }
            }
        }
    });
    
    // Refresh chart function
    function refreshChart(chartId) {
        window.FinanceDashboard.refreshChart(chartId);
    }
</script>
{% endblock %}
